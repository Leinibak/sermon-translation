# ================================================
# Stage 1: Build React App with Vite
# ================================================
FROM node:20-alpine AS build

WORKDIR /app

# 1ï¸âƒ£ ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm ci

# 2ï¸âƒ£ ì†ŒìŠ¤ ë³µì‚¬
COPY . .

# 3ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ (ë°±ì—”ë“œ API URL)
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL

# public í´ë” ì—†ìœ¼ë©´ ìƒì„±
RUN mkdir -p public

# ğŸ“Œ pdf.worker.mjsë¥¼ publicë¡œ ë³µì‚¬
RUN cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/pdf.worker.mjs

# 4ï¸âƒ£ Vite ë¹Œë“œ
RUN npm run build -- --mode production

# ================================================
# Stage 2: Nginx â€” Serve static files
# ================================================
FROM nginx:stable-alpine

# 1ï¸âƒ£ ë¹Œë“œ ê²°ê³¼ ë³µì‚¬
COPY --from=build /app/dist /usr/share/nginx/html

# 2ï¸âƒ£ Nginx ì„¤ì • ë³µì‚¬
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 3ï¸âƒ£ í¼ë¯¸ì…˜ ë° ê¶Œí•œ ì¡°ì •
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
