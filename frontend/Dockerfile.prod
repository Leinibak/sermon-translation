# ================================================
# Stage 1: Build React App with Vite
# ================================================
FROM node:20-alpine AS build

WORKDIR /app

# 1️⃣ 의존성 설치
COPY package*.json ./
RUN npm ci

# 2️⃣ 소스 복사
COPY . .

# 3️⃣ 환경변수 (백엔드 API URL)
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL

# 4️⃣ Vite 빌드
RUN npm run build

# ================================================
# Stage 2: Nginx — Serve static files
# ================================================
FROM nginx:stable-alpine

# 1️⃣ 빌드 결과 복사
COPY --from=build /app/dist /usr/share/nginx/html

# 2️⃣ Nginx 설정 복사
COPY nginx/nginx.prod.conf /etc/nginx/conf.d/default.conf

# 3️⃣ 퍼미션 및 권한 조정
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
